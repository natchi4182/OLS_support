<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>骨粗鬆症診療支援ツール</title>

  <script>
    /** keyToLabelMap は「フォーム name」 → 「ラベル」の対応表 */
    const keyToLabelMap = {
      hospital: "医療機関名",
      doctor: "医師名",
      patient_id: "患者ID",
      age: "年齢",
      sex: "性別",
      height: "身長",
      weight: "体重",
      smoking: "現在の喫煙状況",
      alcohol: "アルコール摂取量",
      diseases: "基礎疾患",
      fracture_history: "骨脆弱性骨折の既往",
      osteoporosis_meds: "現在投与中の骨粗鬆症治療薬",
      hrt_meds: "ホルモン補充療法",
      bone_metabolism_meds: "骨代謝，骨折，転倒に関連する薬剤",
      anticancer_meds: "骨代謝に関連する抗癌剤の使用",
      others: "その他",
      otherinfo: "その他の情報",
      lumbar_bmd: "腰椎骨密度",
      lumbar_yam: "腰椎YAM値",
      femur_bmd: "大腿骨近位骨密度",
      femur_yam: "大腿骨近位YAM値"
    };
  </script>

  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 20px auto;
    }
    fieldset {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 10px;
    }
    legend {
      font-weight: bold;
    }
    label {
      display: block;
      margin: 5px 0;
    }
    .inline-label {
      display: inline-block;
      margin-right: 15px;
      margin-bottom: 5px;
    }
    select, input[type=text], input[type=number], textarea {
      width: 100%;
      max-width: 500px;
      font-size: 1.5em;
    }
    .checkbox-group, .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .checkbox-group label, .radio-group label {
      display: inline-block;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }
    .lab-table input[type="text"],
    .lab-table input[type="number"] {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin-top: 20px;
      padding: 10px 15px;
      background: #4CAF50;
      color: #fff;
      border: none;
      cursor: pointer;
      border-radius: 3px;
      width: 150px;
      height: 60px;
      font-size: 1.2em;
    }
    button:hover {
      background: #45a049;
    }
    /* クリアボタンのスタイル調整 */
    #clearBtn {
      background: #f44336; /* 赤系 */
      margin-left: 10px;
    }
    #clearBtn:hover {
      background: #d32f2f;
    }
    .long-slider {
      width: 500px;
    }
    .short-slider {
      width: 130px;
    }
    #resultArea {
      width: 100%;
      max-width: 500px;
      height: 500px;
      margin-top: 20px;
      box-sizing: border-box;
      font-size: 1em;
      white-space: pre-wrap;
    }
    /* Visually Hidden Class for Accessibility */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap; /* 文字が折り返されないようにする */
      border: 0;
    }
    /* エラーメッセージのスタイル */
    .error-message {
      color: red;
      font-size: 0.9em;
      margin-left: 10px;
    }
  </style>
</head>

<body>

  <h1>骨粗鬆症診療支援ツール</h1>
  <h4>※:必須項目</h4>

  <form id="mainForm">
    <fieldset>
      <legend>医療機関名・医師名(※)</legend>
      <label for="hospitalInput">医療機関を選択してください:</label>
      <select id="hospitalInput" name="hospital" required>
        <option value="">選択してください</option>
      </select>

      <label for="doctorInput">医師を選択してください:</label>
      <select id="doctorInput" name="doctor" required>
        <option value="">選択してください</option>
      </select>
    </fieldset>

    <fieldset>
      <legend>患者ID(※)</legend>
      <label for="patientIdInput">患者ID:</label>
      <input type="text" id="patientIdInput" name="patient_id" required>
    </fieldset>

    <fieldset>
      <legend>年齢(※)</legend>
      <label for="ageInput">年齢:</label>
      <input type="number" id="ageNumber" name="age" min="0" max="120" step="1" required>
      <input type="range" class="long-slider" id="ageInput" min="0" max="120" step="1">
      <br>
      <span id="ageError" class="error-message visually-hidden">年齢は0から120の間で入力してください。</span>
    </fieldset>

    <fieldset>
      <legend>性別(※)</legend>
      <div class="radio-group">
        <label class="inline-label">
          <input type="radio" name="sex" value="閉経前女性" required aria-required="true"> 閉経前女性
        </label>
        <label class="inline-label">
          <input type="radio" name="sex" value="閉経後女性" aria-required="true"> 閉経後女性
        </label>
        <label class="inline-label">
          <input type="radio" name="sex" value="男性" aria-required="true"> 男性
        </label>
      </div>
    </fieldset>

    <fieldset>
      <legend>身長・体重</legend>
      <label for="heightInput">身長（cm）:</label>
      <input type="number" id="heightNumber" name="height" min="100" max="200" step="0.1">
      <input type="range" class="long-slider" id="heightInput" min="100" max="200" step="0.1">
      <hr>
      <label for="weightInput">体重（kg）:</label>
      <input type="number" id="weightNumber" name="weight" min="20" max="150" step="0.1">
      <input type="range" class="long-slider" id="weightInput" min="20" max="150" step="0.1">
    </fieldset>

    <fieldset>
      <legend>生活習慣</legend>
      <label for="smokingInput">現在の喫煙について選択してください:</label>
      <select id="smokingInput" name="smoking">
        <option value="">選択してください</option>
      </select>
      <hr>
      <label for="alcoholInput">アルコール摂取について選択してください:</label>
      <select id="alcoholInput" name="alcohol">
        <option value="">選択してください</option>
      </select>
      <br>
      <span style="font-size: 0.8em">アルコール摂取量1単位=8～10g</span>
      <br>
      <span style="font-size: 0.8em">　　　ビール: グラス1杯 285ml　　　蒸留酒: シングル 30ml　　　ワイン: グラス1杯 120ml　　　食前酒: シングル 60ml</span>
    </fieldset>

    <fieldset>
      <legend>基礎疾患</legend>
      <div id="diseaseContainer" class="checkbox-group">
        <!-- diseases_list.jsonから読み込み、チェックボックス生成 -->
      </div>
    </fieldset>

    <fieldset>
      <legend>骨折歴（骨粗鬆症性のみ）</legend>
      <div id="fractureHistoryContainer" class="checkbox-group">
      </div>
    </fieldset>

    <fieldset>
      <legend>使用中の骨粗鬆症治療薬</legend>
      <div id="osteoporosisMedsContainer" class="checkbox-group">
      </div>
    </fieldset>

    <fieldset>
      <legend>HRT（ホルモン補充療法）</legend>
      <div id="hrtMedsContainer" class="checkbox-group">
      </div>
    </fieldset>

    <fieldset>
      <legend>骨代謝・骨折・転倒関連薬剤</legend>
      <div id="boneMetabolismMedsContainer" class="checkbox-group">
      </div>
    </fieldset>

    <fieldset>
      <legend>骨代謝に関連する抗癌剤</legend>
      <div id="anticancerMedsContainer" class="checkbox-group">
      </div>
      <br>
      <span style="font-size: 0.8em">　　　▲: 骨量増加作用　　　▼: 骨量減少作用　　　▶︎: 骨量減少抑制作用</span>
    </fieldset>

    <fieldset>
      <legend>その他</legend>
      <div id="othersContainer" class="checkbox-group">
      </div>
    </fieldset>

    <fieldset>
      <legend>追加項目</legend>
      <textarea id="otherinfoInput" name="otherinfo" rows="5"></textarea>
    </fieldset>

    <fieldset>
      <legend>骨密度</legend>
      <label for="lumbarBMD">腰椎（g/cm²）:</label>
      <input type="number" id="lumbarBMDNumber" name="lumbar_bmd" min="0.000" max="2.000" step="0.001">
      <input type="range" class="long-slider" id="lumbarBMD" min="0.000" max="2.000" step="0.001">
      <label for="lumbarYAM">YAM値（%）:</label>
      <input type="number" id="lumbarYAMNumber" name="lumbar_yam" min="0" max="200" step="1">
      <input type="range" class="long-slider" id="lumbarYAM" min="0" max="200" step="1">
      <hr>
      <label for="femurBMD">大腿骨近位（g/cm²）:</label>
      <input type="number" id="femurBMDNumber" name="femur_bmd" min="0.000" max="2.000" step="0.001">
      <input type="range" class="long-slider" id="femurBMD" min="0.000" max="2.000" step="0.001">
      <label for="femurYAM">YAM値（%）:</label>
      <input type="number" id="femurYAMNumber" name="femur_yam" min="0" max="200" step="1">
      <input type="range" class="long-slider" id="femurYAM" min="0" max="200" step="1">
    </fieldset>

    <fieldset>
      <legend>検体検査データ</legend>
      <table class="lab-table">
        <thead>
          <tr>
            <th style="width: 150px;">項目名</th>
            <th style="width: 150px;">結果</th>
            <th style="width: 150px;">単位</th>
            <th style="width: 300px;">正常値・参考値</th>
          </tr>
        </thead>
        <tbody id="labDataTable"></tbody>
      </table>
    </fieldset>
  </form>

  <div class="button-row">
    <button id="checkBtn">確認</button>
    <button id="submitBtn">送信</button>
    <button id="copyBtn">コピー&GPT</button>
    <button type="button" id="clearBtn">クリア</button>
  </div>

  <textarea id="resultArea" placeholder="入力データ確認エリア"></textarea>

<script>
  document.addEventListener('DOMContentLoaded', async () => {

    /** 
     * keyToLabelMap は既に定義済み 
     */

    // -----------------------------
    // 1) 正常値を保持するオブジェクト
    // -----------------------------
    // この部分は削除します。labDataItems.json内の'normal'オブジェクトを使用します。

    // -----------------------------
    // 2) スライダーと数値の要素を同期
    // -----------------------------
    const synchronizeInputs = (numberInputId, sliderInputId) => {
      const numberInput = document.getElementById(numberInputId);
      const sliderInput = document.getElementById(sliderInputId);

      sliderInput.addEventListener('input', () => {
        numberInput.value = sliderInput.value;
        validateLabInput(numberInput);
        updateNormalValues(); // 正常値を更新
      });
      numberInput.addEventListener('input', () => {
        sliderInput.value = numberInput.value;
        validateLabInput(numberInput);
        updateNormalValues(); // 正常値を更新
      });
    };

    synchronizeInputs('ageNumber', 'ageInput');
    synchronizeInputs('heightNumber', 'heightInput');
    synchronizeInputs('weightNumber', 'weightInput');
    synchronizeInputs('lumbarBMDNumber', 'lumbarBMD');
    synchronizeInputs('lumbarYAMNumber', 'lumbarYAM');
    synchronizeInputs('femurBMDNumber', 'femurBMD');
    synchronizeInputs('femurYAMNumber', 'femurYAM');

    // -----------------------------
    // 3) JSONファイルから各種選択肢を動的読込
    // -----------------------------
    await populateSelect('https://natchi4182.github.io/OLS_support/hospital_list.json' , 'hospitalInput');
    await populateSelect('https://natchi4182.github.io/OLS_support/doctor_list.json' , 'doctorInput');
    await populateCheckboxes('https://natchi4182.github.io/OLS_support/diseases_list.json' , 'diseaseContainer', 'diseases');
    await populateSelect('https://natchi4182.github.io/OLS_support/smoking_list.json' , 'smokingInput');
    await populateSelect('https://natchi4182.github.io/OLS_support/alcohol_list.json' , 'alcoholInput');

    // 特定jsonだけ®を上付きに変換
    await populateCheckboxes('https://natchi4182.github.io/OLS_support/osteoporosis_meds.json' , 'osteoporosisMedsContainer', 'osteoporosis_meds');
    await populateCheckboxes('https://natchi4182.github.io/OLS_support/hrt_meds.json' , 'hrtMedsContainer', 'hrt_meds');
    await populateCheckboxes('https://natchi4182.github.io/OLS_support/anticancer_meds.json' , 'anticancerMedsContainer', 'anticancer_meds');

    // 変換しないチェックボックス
    await populateCheckboxes('https://natchi4182.github.io/OLS_support/bone_metabolism_meds.json' , 'boneMetabolismMedsContainer', 'bone_metabolism_meds');
    await populateCheckboxes('https://natchi4182.github.io/OLS_support/fracture_history.json' , 'fractureHistoryContainer', 'fracture_history');
    await populateCheckboxes('https://natchi4182.github.io/OLS_support/others.json' , 'othersContainer', 'others');

    // -----------------------------
    // 4) 検体検査データ テーブルの生成
    // -----------------------------
    // 外部JSONからlabDataItemsを取得
    let labDataItems = [];
    try {
      const response = await fetch('https://natchi4182.github.io/OLS_support/labDataItems.json');
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      labDataItems = await response.json();
    } catch (error) {
      console.error('labDataItems.jsonの読み込みに失敗しました:', error);
      alert('検体検査データの読み込みに失敗しました。コンソールを確認してください。');
    }

    // labDataMap: 検査項目→単位の対応
    const labDataMap = {};
    labDataItems.forEach(item => {
      labDataMap[item.name] = item.unit;
    });
    // 一般項目にも単位付与
    labDataMap["height"] = "cm";
    labDataMap["weight"] = "kg";
    labDataMap["lumbar_bmd"] = "g/cm²";
    labDataMap["lumbar_yam"] = "%";
    labDataMap["femur_bmd"] = "g/cm²";
    labDataMap["femur_yam"] = "%";

    const labDataTable = document.getElementById('labDataTable');
    labDataItems.forEach(item => {
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      tdName.textContent = item.name;
      tr.appendChild(tdName);

      const tdInput = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'number';
      input.name = item.name;
      input.step = item.step;
      input.min = item.min || ""; // Optional: Add min if available
      input.max = item.max || ""; // Optional: Add max if available
      tdInput.appendChild(input);
      tr.appendChild(tdInput);

      const tdUnit = document.createElement('td');
      tdUnit.textContent = item.unit;
      tr.appendChild(tdUnit);

      const tdNormal = document.createElement('td');
      tdNormal.textContent = "性別により異なる"; // 初期表示
      tr.appendChild(tdNormal);

      labDataTable.appendChild(tr);
    });

    // -----------------------------
    // 5) ボタン別のイベント定義
    // -----------------------------
    // (A) 「確認」ボタン
    document.getElementById('checkBtn').addEventListener('click', (e) => {
      e.preventDefault();

      const form = document.getElementById('mainForm');
      const resultArea = document.getElementById('resultArea');
      const formData = new FormData(form);

      // 必須項目のチェック
      const requiredFields = form.querySelectorAll('[required]');
      let allValid = true;
      const radioGroups = new Set();

      requiredFields.forEach(field => {
        if (field.type === 'radio') {
          radioGroups.add(field.name);
        } else {
          if (!field.value.trim()) {
            allValid = false;
            field.style.border = '2px solid red';
          } else {
            field.style.border = '';
          }
        }
      });

      // ラジオボタンのグループごとのチェック
      radioGroups.forEach(name => {
        const radios = form.querySelectorAll(`input[name="${name}"]`);
        const isChecked = Array.from(radios).some(radio => radio.checked);
        if (!isChecked) {
          allValid = false;
          radios.forEach(radio => radio.parentElement.style.border = '2px solid red');
        } else {
          radios.forEach(radio => radio.parentElement.style.border = '');
        }
      });

      if (!allValid) {
        alert('必須項目をすべて入力してください。');
        return;
      }

      let output = '【入力データ一覧】\n';

      for (const [key, value] of formData.entries()) {
        if (value === '') continue;

        let labelKey = keyToLabelMap[key] || key;
        let cleanValue = value.replace(/<sup>®<\/sup>/g, "");  // ®マーク削除
        const unit = labDataMap[key];

        if (unit) {
          output += `${labelKey}: ${cleanValue} ${unit}\n`;
        } else {
          output += `${labelKey}: ${cleanValue}\n`;
        }
      }
      resultArea.value = output;
    });

    // (B) 「送信」ボタン (GASへPOST)
    document.getElementById('submitBtn').addEventListener('click', async (e) => {
      e.preventDefault();

      const form = document.getElementById('mainForm');
      const formData = new FormData(form);

      try {
        // WebアプリのURL (doPostを定義しているGAS)
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbxtLrBrObAdOQLs8WvufxKY2cNAeIEUkOSsrtx_264okknmYqCJMlPrvXRihR4Atqp3/exec';

        const response = await fetch(scriptUrl, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`サーバーエラー: ${response.statusText}`);
        }

        const json = await response.json(); 
        alert('送信完了:\n' + json.message);
        localStorage.removeItem('formData'); // 送信完了後にデータをクリア
      } catch (err) {
        console.error('送信失敗', err);
        alert('送信失敗: ' + err.message);
      }
    });

    // (C) 「コピー&GPT」ボタン
    document.getElementById('copyBtn').addEventListener('click', async (e) => {
      e.preventDefault();

      const resultArea = document.getElementById('resultArea');
      const textToCopy = resultArea.value;

      if (!textToCopy) {
        alert('結果表示エリアが空です。');
        return;
      }

      try {
        // クリップボードにコピー
        await navigator.clipboard.writeText(textToCopy);
        alert('クリップボードにコピーしました。');

        // URLを別ウィンドウで表示
        const gptUrl = 'https://chatgpt.com/g/g-6751327a384c8191a75c343ec21a5fcc-gu-cu-song-zheng-nozhen-duan-tozhi-liao-wokaitosurugpt';
        window.open(gptUrl, '_blank');

      } catch (err) {
        console.error('コピー失敗', err);
        alert('コピーできませんでした: ' + err);
      }
    });

    // (D) 「クリア」ボタン
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (confirm('入力データをクリアしてよろしいですか？')) {
        const form = document.getElementById('mainForm');
        form.reset(); // フォームをリセット

        // 検体検査データ テーブルの背景色をリセット
        const labDataTable = document.getElementById('labDataTable');
        const rows = labDataTable.querySelectorAll('tr');
        rows.forEach(row => {
          row.style.backgroundColor = '';
          // 正常値を「性別により異なる」にリセット
          const tdNormal = row.querySelector('td:nth-child(4)');
          if (tdNormal) {
            tdNormal.textContent = "性別により異なる";
          }
        });

        // ローカルストレージをクリア
        localStorage.removeItem('formData');

        // 結果表示エリアをクリア
        document.getElementById('resultArea').value = '';

        // 年齢バリデーションをリセット
        validateAge();
      }
    });

    // -----------------------------
    // 6) populateSelect
    // -----------------------------
    async function populateSelect(jsonPath, selectId) {
      try {
        const res = await fetch(jsonPath);
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`);
        }
        const data = await res.json();
        const select = document.getElementById(selectId);

        data.items.forEach(item => {
          const option = document.createElement('option');
          option.value = item;
          option.textContent = item;
          select.appendChild(option);
        });
      } catch(err) {
        console.error('Error loading', jsonPath, err);
        alert(`選択肢の読み込みに失敗しました: ${selectId}`);
      }
    }

    // -----------------------------
    // 7) populateCheckboxes
    // -----------------------------
    async function populateCheckboxes(jsonPath, containerId, nameAttr) {
      try {
        const res = await fetch(jsonPath);
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`);
        }
        const data = await res.json();
        const container = document.getElementById(containerId);

        // 変換対象ファイル
        const convertTargets = [
          'https://natchi4182.github.io/OLS_support/anticancer_meds.json',
          'https://natchi4182.github.io/OLS_support/hrt_meds.json',
          'https://natchi4182.github.io/OLS_support/osteoporosis_meds.json'
        ];
        const doConvert = convertTargets.includes(jsonPath);

        data.items.forEach(item => {
          // 特定ファイルだけ ® を上付きに変換
          let displayItem = item;
          if (doConvert) {
            displayItem = item.replace(/®/g, '<sup>®</sup>');
          }

          const labelElem = document.createElement('label');
          labelElem.classList.add('inline-label');

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.name = nameAttr;
          input.value = item;
          labelElem.appendChild(input);

          const span = document.createElement('span');
          span.innerHTML = ' ' + displayItem;
          labelElem.appendChild(span);

          container.appendChild(labelElem);
        });
      } catch(err) {
        console.error('Error loading', jsonPath, err);
        alert(`チェックボックスの読み込みに失敗しました: ${nameAttr}`);
      }
    }

    // -----------------------------
    // 8) 検体検査データ テーブルの色変更と正常値の表示
    // -----------------------------
    function getSelectedSex() {
      const sexRadios = document.querySelectorAll('input[name="sex"]');
      for (let radio of sexRadios) {
        if (radio.checked) {
          return radio.value;
        }
      }
      return null;
    }

    function getNormalValue(item) {
      const selectedSex = getSelectedSex();
      if (!selectedSex) {
        return "性別により異なる"; // 性別が選択されていない場合
      }

      const normalRangeStr = item.normal ? item.normal[selectedSex] : null;
      if (!normalRangeStr) {
        return "未定義"; // 正常値が定義されていない場合
      }

      return normalRangeStr;
    }

    function validateLabInput(numberInput) {
      const tr = numberInput.closest('tr');
      const name = numberInput.name;
      const value = parseFloat(numberInput.value);
      const item = labDataItems.find(item => item.name === name);

      if (item) {
        const selectedSex = getSelectedSex();
        if (!selectedSex) {
          tr.style.backgroundColor = '';
          return;
        }

        const normalRangeStr = getNormalValue(item);
        if (normalRangeStr === "性別により異なる" || normalRangeStr === "未定義") {
          tr.style.backgroundColor = '';
          return;
        }

        const normalParts = normalRangeStr.split('〜').map(v => v.trim());

        let min = parseFloat(normalParts[0]);
        let max = parseFloat(normalParts[1]);

        if (isNaN(max)) {
          max = Infinity;
        }

        if (isNaN(value)) {
          tr.style.backgroundColor = '';
        } else if (value < min) {
          tr.style.backgroundColor = '#bbdefb'; // 青系
        } else if (value > max) {
          tr.style.backgroundColor = '#ffebee'; // 赤系
        } else {
          tr.style.backgroundColor = '#e8f5e9'; // 緑系
        }
      }
    }

    function updateNormalValues() {
      labDataItems.forEach(item => {
        const input = document.querySelector(`input[name="${item.name}"]`);
        if (input) {
          const tr = input.closest('tr');
          const tdNormal = tr.querySelector('td:nth-child(4)');
          tdNormal.textContent = getNormalValue(item);
          validateLabInput(input);
        }
      });
    }

    labDataTable.addEventListener('input', (e) => {
      if (e.target && e.target.tagName.toLowerCase() === 'input') {
        const input = e.target;
        validateLabInput(input);
      }
    });

    // 性別変更時に検査結果を再検証
    const sexRadios = document.querySelectorAll('input[name="sex"]');
    sexRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        updateNormalValues();
      });
    });

    // -----------------------------
    // 9) リアルタイムバリデーションとエラーメッセージの追加
    // -----------------------------
    const ageNumber = document.getElementById('ageNumber');
    const ageInputRange = document.getElementById('ageInput');
    const ageError = document.getElementById('ageError');

    const validateAge = () => {
      const value = parseInt(ageNumber.value, 10);
      if (isNaN(value) || value < 0 || value > 120) {
        ageNumber.style.border = '2px solid red';
        ageInputRange.style.border = '2px solid red';
        ageError.classList.remove('visually-hidden');
      } else {
        ageNumber.style.border = '';
        ageInputRange.style.border = '';
        ageError.classList.add('visually-hidden');
      }
    };

    ageNumber.addEventListener('input', validateAge);
    ageInputRange.addEventListener('input', validateAge);

    // -----------------------------
    // 10) データの保存と復元
    // -----------------------------
    // フォームのデータを保存
    const formElement = document.getElementById('mainForm');
    formElement.addEventListener('input', () => {
      const formData = new FormData(formElement);
      const data = {};
      formData.forEach((value, key) => {
        // チェックボックスは複数選択可能なので配列で保存
        if (data[key]) {
          if (Array.isArray(data[key])) {
            data[key].push(value);
          } else {
            data[key] = [data[key], value];
          }
        } else {
          data[key] = value;
        }
      });
      localStorage.setItem('formData', JSON.stringify(data));
    });

    // ページ読み込み時にデータを復元
    const savedData = JSON.parse(localStorage.getItem('formData'));
    if (savedData) {
      for (const key in savedData) {
        if (savedData.hasOwnProperty(key)) {
          const element = formElement.elements.namedItem(key);
          if (element) {
            if (element.type === 'radio' || element.type === 'checkbox') {
              const values = Array.isArray(savedData[key]) ? savedData[key] : [savedData[key]];
              Array.from(formElement.elements.namedItem(key)).forEach(radio => {
                radio.checked = values.includes(radio.value);
              });
            } else {
              element.value = savedData[key];
            }
          }
        }
      }

      // 性別変更時に再検証と正常値の更新
      const selectedSex = getSelectedSex();
      if (selectedSex) {
        updateNormalValues();

        // 年齢バリデーションの再実行
        validateAge();
      }
    }

  }); // DOMContentLoaded end

  // -----------------------------
  // 10) その他の関数
  // -----------------------------
  // labDataMapは前述のスクリプト内で定義済み
</script>

</body>
</html>
